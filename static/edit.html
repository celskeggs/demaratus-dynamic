<!DOCTYPE html>
<html lang="en">
<head>
<title>Demaratus Editor</title>
<style type="text/css" media="screen">
	#editor { 
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 320px;
	}
	#sidebar {
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		width: 300px;
		background-color: #272822;
		color: #8f908a;
		padding: 10px;
		font: 15px "Monaco","Menlo","Ubuntu Mono","Consolas","source-code-pro",monospace;
	}
	.header {
		position: relative;
		left: 0;
		right: 0;
		text-align: center;
		margin-bottom: 10px;
	}
	.flash {
		color: red;
	}
</style>
<script type="text/javascript" src="/static/sjcl.js"></script>
</head>
<body>

<div id="sidebar">
	<div class="header">Demaratus Editor</div>
	<div class="header" id="globalbtns"></div>
	<div class="header">
		<button type="button" id="fetch">FETCH</button>
		<button type="button" id="new">NEW</button>
	</div>
	<div class="header" id="filelist-msg">Preloading...</div>
	<div class="header">
		<button type="button" id="add-cred">ADD</button>
	</div>
	<div class="header">
		<button type="button" id="decrypt-any">DECRYPT*</button>
		<button type="button" id="decrypt-one">DECRYPT</button>
		<button type="button" id="encrypt">ENCRYPT</button>
	</div>
	<div id="credlist"></div>
	<div class="header">
		<button type="button" id="refresh">REFRESH</button>
		<button type="button" id="save">SAVE</button>
		<button type="button" id="load">LOAD</button>
	</div>
	<div id="filelist"></div>
</div>
<div id="editor">Loading...</div>

<script src="/static/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/clist.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/btnset.js" type="text/javascript" charset="utf-8"></script>
<!-- <script src="/static/jsencrypt/jsencrypt.min.js" type="text/javascript" charset="utf-8"></script> -->
<script src="/static/data.js" type="text/javascript" charset="utf-8"></script>
<script>
	var editor = ace.edit("editor");
	editor.setTheme("ace/theme/monokai");
	// editor.getSession().setMode("ace/mode/javascript");
	var raw = "Enter text here.";
	editor.setValue(raw);
	var filelist = clist_bind("filelist", "blocks", function(x) {return x;}), credlist = clist_bind("credlist", "credentials", function(x) {return x;});
	var globalbtns = btnset_bind("globalbtns");
	globalbtns.add("FETCH", function() {
		var key = prompt("Enter Key");
		if (key) {
			load_document(key);
		}
	});
	globalbtns.add("NEW", function() {
		editor.setValue("");
	});
	document.getElementById("save").onclick = function() {
		d_put(editor.getValue(), function(key) {
			editor.setValue("Saved as " + key);
			setTimeout("refresh_listing()", 500);
		}, function(x) {
			alert("Could not save: " + x);
			setTimeout("refresh_listing()", 500);
		});
	};
	function load_document(key) {
		key = d_undashed(key);
		editor.setValue("Loading: " + key);
		d_get(key, function(data) {
			editor.setValue(data);
		}, function(x) {
			editor.setValue("Failed loading " + key + " (" + x + ")");
		});
	}
	document.getElementById("add-cred").onclick = function() {
		var key = prompt("Enter Password");
		if (key) {
			credlist.add(key);
		}
	};
	document.getElementById("encrypt").onclick = function() {
		var selected = credlist.selected();
		if (selected !== null) {
			var encrypted = d_encrypt(selected, editor.getValue());
			set_document_readout("Encrypted.");
			editor.setValue(encrypted);
		}
	};
	document.getElementById("decrypt-one").onclick = function() {
		var selected = credlist.selected();
		if (selected !== null) {
			var decrypted = d_decrypt(selected, editor.getValue());
			if (decrypted !== null) {
				set_document_readout("Decrypted.");
				editor.setValue(decrypted);
			} else {
				set_document_readout("Failed.");
				flash_document_readout();
			}
		}
	};
	document.getElementById("decrypt-any").onclick = function() {
		var decrypted = d_decrypt_any(credlist, editor.getValue());
		if (decrypted.success) {
			set_document_readout("Working credential: #" + decrypted.key_id + ".");
			editor.setValue(decrypted.out);
		} else {
			set_document_readout("No working credentials.");
			flash_document_readout();
		}
	};
	function flash_document_readout() {
		document.getElementById("filelist-msg").classList.add("flash");
		setTimeout("document.getElementById('filelist-msg').classList.remove('flash')", 500);
	}
	function set_document_readout(msg) {
		document.getElementById("filelist-msg").textContent = msg;
	}
	document.getElementById("load").onclick = function() {
		var key = filelist.selected();
		if (key) {
			load_document(key);
		}
	};
	function set_class(elem, cls, value) {
		if (value) {
			elem.classList.add(cls);
		} else {
			elem.classList.remove(cls);
		}
	}
	function refresh_local() {
		// editor.setValue(d_encrypt(this.textContent, editor.getValue()));
		set_class(document.getElementById("load"), "disabled", filelist.selected() === null);
		var value = editor.getValue();
		var valid_decrypt = value !== null && value.contains("\"iv\":\"") && value.contains("\"salt\":\"");
		set_class(document.getElementById("decrypt-one"), "disabled", !valid_decrypt || credlist.selected() === null);
		set_class(document.getElementById("decrypt-any"), "disabled", !valid_decrypt);
		set_class(document.getElementById("encrypt"), "disabled", credlist.selected() === null);
	}
	filelist.listeners.push(refresh_local);
	credlist.listeners.push(refresh_local);
	editor.on("change", refresh_local);
	function refresh_listing() {
		set_document_readout("Depopulating...");
		filelist.clear();
		set_document_readout("Loading...");
		d_list(function(data) {
			set_document_readout("Repopulating...");
			for (var i=0; i<data.length; i++) {
				filelist.add(d_dashed(data[i]));
			}
			set_document_readout("Loaded.");
		}, function(x) {
			set_document_readout("Error: " + x);
		});
	}
	document.getElementById("refresh").onclick = refresh_listing;
	refresh_local();
	refresh_listing();
</script>
</body>
</html>
