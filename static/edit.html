<!DOCTYPE html>
<html lang="en">
<head>
<title>Demaratus Editor</title>
<style type="text/css" media="screen">
	#editor { 
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 320px;
	}
	#filelist {
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		width: 300px;
		background-color: #272822;
		color: #8f908a;
		padding: 10px;
		font: 15px "Monaco","Menlo","Ubuntu Mono","Consolas","source-code-pro",monospace;
	}
	#filelist button {
		position: relative;
		background-color: #277822;
		border: none;
		color: white;
		font: 15px "Monaco","Menlo","Ubuntu Mono","Consolas","source-code-pro",monospace;
	}
	#filelist button.disabled {
		background-color: #772822;
	}
	.noselect {
		/* -webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none; */
	}
	.header {
		position: relative;
		left: 0;
		right: 0;
		text-align: center;
		margin-bottom: 10px;
	}
	.listing {
		padding-left: 0px;
		list-style-type: none;
	}
	.listing .selected {
		padding-left: 0px;
		list-style-type: none;
		color: white;
	}
	.listing li {
		margin-left: 0px;
		background-color: #373832;
		margin-bottom: 10px;
		text-align: center;
	}
	.listing li:hover {
		background-color: #474842;
	}
	.listing li:active {
		background-color: #575852;
	}
</style>
<script type="text/javascript" src="/static/sjcl.js"></script>
</head>
<body>

<div id="filelist" class="noselect">
	<div class="header">Document Listing</div>
	<div class="header">
		<button type="button" id="fetch">FETCH</button>
		<button type="button" id="new">NEW</button>
	</div>
	<div class="header" id="filelist-msg">Preloading...</div>
	<div class="header">
		<button type="button" id="add-cred">ADD</button>
		<button type="button" id="decrypt-any">DECRYPT*</button>
		<button type="button" id="decrypt-one">DECRYPT</button>
	</div>
	<ul class="listing" id="credlist-list">
	<li>Please wait</li>
	</ul>
	<div class="header">
		<button type="button" id="refresh">REFRESH</button>
		<button type="button" id="save">SAVE</button>
		<button type="button" id="load">LOAD</button>
	</div>
	<ul class="listing" id="filelist-list">
	<li>Please wait</li>
	</ul>
</div>
<div id="editor">Loading...</div>

<script src="/static/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<!-- <script src="/static/jsencrypt/jsencrypt.min.js" type="text/javascript" charset="utf-8"></script> -->
<script src="/static/data.js" type="text/javascript" charset="utf-8"></script>
<script>
	var editor = ace.edit("editor");
	editor.setTheme("ace/theme/monokai");
	// editor.getSession().setMode("ace/mode/javascript");
	var raw = "Enter text here.";
	editor.setValue(raw);
	document.getElementById("save").onclick = function() {
		d_put(editor.getValue(), function(key) {
			editor.setValue("Saved as " + key);
			setTimeout("refresh_listing()", 500);
		}, function(x) {
			alert("Could not save: " + x);
			setTimeout("refresh_listing()", 500);
		});
	};
	function load_document(key) {
		key = d_undashed(key);
		editor.setValue("Loading: " + key);
		d_get(key, function(data) {
			editor.setValue(data);
		}, function(x) {
			editor.setValue("Failed loading " + key + " (" + x + ")");
		});
	}
	document.getElementById("fetch").onclick = function() {
		var key = prompt("Enter Key");
		if (key) {
			load_document(key);
		}
	};
	document.getElementById("new").onclick = function() {
		editor.setValue("");
	};
	document.getElementById("add-cred").onclick = function() {
		var key = prompt("Enter Password");
		if (key) {
			d_add_credential(key);
			refresh_local();
		}
	};
	document.getElementById("decrypt-any").onclick = function() {
		var decrypted = d_decrypt_any(editor.getValue());
		if (decrypted.success) {
			set_document_readout("Working credential: #" + decrypted.key_id + ".");
			editor.setValue(decrypted.out);
		} else {
			set_document_readout("No working credentials.");
		}
	};
	function set_document_readout(msg) {
		document.getElementById("filelist-msg").textContent = msg;
	}
	function set_select(ent, unselect) {
		for (var i=0; i<ent.parentNode.children.length; i++) {
			ent.parentNode.children[i].classList.remove("selected");
		}
		if (!unselect) {
			ent.classList.add("selected");
		}
	}
	function get_select(ent) {
		for (var i=0; i<ent.children.length; i++) {
			if (ent.children[i].classList.contains("selected")) {
				return ent.children[i];
			}
		}
		return null;
	}
	document.getElementById("load").onclick = function() {
		var key = get_select(document.getElementById("filelist-list"));
		if (key) {
			load_document(key.textContent);
		}
	};
	function set_class(elem, cls, value) {
		if (value) {
			elem.classList.add(cls);
		} else {
			elem.classList.remove(cls);
		}
	}
	function refresh_local() {
		var list = document.getElementById("credlist-list");
		while (list.children.length) {
			list.removeChild(list.children[0]);
		}
		var elem = document.createElement("li");
		elem.textContent = d_count_credentials() + " credentials:";
		list.appendChild(elem);
		d_list_credentials(function(line) {
			var elem = document.createElement("li");
			elem.textContent = line;
			elem.onclick = function() {
				editor.setValue(d_encrypt(this.textContent, editor.getValue()));
			}.bind(elem);
			list.appendChild(elem);
		});
		var selected = get_select(document.getElementById("filelist-list"));
		set_class(document.getElementById("load"), "disabled", selected === null);
	}
	function refresh_listing() {
		set_document_readout("Depopulating...");
		var list = document.getElementById("filelist-list");
		while (list.children.length) {
			list.removeChild(list.children[0]);
		}
		set_document_readout("Loading...");
		d_list(function(data) {
			set_document_readout("Repopulating...");
			var elem = document.createElement("li");
			elem.textContent = data.length + " blocks:";
			elem.onclick = function() {
				set_select(this, true);
				refresh_local();
			}.bind(elem);
			list.appendChild(elem);
			for (var i=0; i<data.length; i++) {
				var elem = document.createElement("li");
				elem.textContent = d_dashed(data[i]);
				elem.onclick = function() {
					set_select(this);
					refresh_local();
				}.bind(elem);
				list.appendChild(elem);
			}
			set_document_readout("Loaded.");
		}, function(x) {
			set_document_readout("Error: " + x);
		});
	}
	document.getElementById("refresh").onclick = refresh_listing;
	refresh_local();
	refresh_listing();
</script>
</body>
</html>
